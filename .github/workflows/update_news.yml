# GitHub Actions: RSS í”¼ë“œ ìë™ ìˆ˜ì§‘ ë° ë°°í¬
# ìŠ¤ì¼€ì¤„: ë§¤ì¼ 6ì‹œê°„ë§ˆë‹¤ (00:00, 06:00, 12:00, 18:00 UTC)
# ìˆ˜ë™ ì‹¤í–‰: GitHub Actions íƒ­ì—ì„œ "Run workflow" ë²„íŠ¼ í´ë¦­

name: Update News Feeds

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (cron)
  schedule:
    # UTC ê¸°ì¤€: 00:00, 06:00, 12:00, 18:00
    # í•œêµ­ ì‹œê°„: 09:00, 15:00, 21:00, 03:00
    - cron: '0 0,6,12,18 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©
  workflow_dispatch:
  
  # Push ì‹œì—ë„ ì‹¤í–‰ (ì„ íƒ ì‚¬í•­ - ì£¼ì„ í•´ì œí•˜ë©´ í™œì„±í™”)
  # push:
  #   branches: [ main ]
  #   paths:
  #     - 'scripts/fetchFeeds.js'

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      # 2. Node.js ì„¤ì •
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      # 4. RSS í”¼ë“œ ìˆ˜ì§‘
      - name: ğŸ”„ Fetch RSS feeds
        run: node scripts/fetchFeeds.js
      
      # 5. ë³€ê²½ì‚¬í•­ í™•ì¸
      - name: ğŸ” Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/news.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes in news.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "News data updated"
          fi
      
      # 6. ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ (ì„ íƒ ì‚¬í•­)
      # Git ì»¤ë°‹ì„ ì›í•˜ì§€ ì•Šìœ¼ë©´ ì´ ë‹¨ê³„ë¥¼ ì£¼ì„ ì²˜ë¦¬í•˜ì„¸ìš”
      - name: ğŸ’¾ Commit changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add public/news.json
          git commit -m "chore: update news feed [$(date +'%Y-%m-%d %H:%M UTC')]"
          git push
      
      # 7. Firebaseì— ë°°í¬
      - name: ğŸš€ Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
      
      # 8. ë°°í¬ ì™„ë£Œ ì•Œë¦¼
      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ News feeds updated and deployed successfully!"
          echo "ğŸ“Š Check the live site for latest articles"
